<h2>实现基于目录的配额

参考文献：[Linux Disk Quota实践 – 智汇云技术社区 (360.cn)](https://zyun.360.cn/blog/?p=2148)

前期准备：确定selinux关闭

```she
# 查看selinux状态
sestatus -v
# 临时关闭
setenforce 0
# 永久关闭方法一
vim /etc/selinux/conig
SELINUX=disabled
# 永久关闭方法二
sed -i 's/SELINUX=enabled/SELINUX=disabled/g' /etc/selinux/config
```

1. 添加quota激活选项，基于需求，添加usrquota（用户配额），grpquota（组配额），prjquota（项目配额）。这里使用的是prjquota

```shell
# vi /etc/fstab
/dev/sdb1	/data	xfs	defaults,prjquota	0 0
```

2. 挂载目录

   ```shel
   # 避免已挂载
   umount /data
   # 检查是否有错误
   mount -a
   # 无错误后重启机器
   reboot
   # 重启后检查
   mount | grep data
   /dev/sdb1 on /data type xfs (rw,relatime,attr2,inode64,prjquota)
   ```

3. 查看配额是否开启

​	<img src="/Users/apple/Desktop/wiki图片存放/image-20230608150035528.png" alt="image-20230608150035528" style="zoom:50%;" />

4. 创建目录和项目名对应关系

   ```shell 
   ##创建项目id与目录的对应关系
   echo "1:/data/testdata" >> /etc/projects
   ##创建项目id与项目名称的对应关系，即给项目id起个别名
   echo "testdata:1" >> /etc/projid
   ```

   初始化项目语句如下：

   ```shell
   # xfs_quota -x -c "project -s testdata"
   Setting up project testdata (path /data/testdata)...
   Processed 1 (/etc/projects and cmdline) paths for project testdata with recursion depth infinite (-1).
   Setting up project testdata (path /data/testdata)...
   Processed 1 (/etc/projects and cmdline) paths for project testdata with recursion depth infinite (-1).
   Setting up project testdata (path /data/testdata)...
   Processed 1 (/etc/projects and cmdline) paths for project testdata with recursion depth infinite (-1).
   ```

   查看目录是否存在对应项目：

   ```she
   # xfs_quota -x -c "print" /data
   Filesystem          Pathname
   /data               /dev/sdb1 (pquota)
   /data/testdata     /dev/sdb1 (project 1, testdata)
   ```

   5. 设置目录quota大小

      ```shel
      ##针对项目mysqldata设置10M容量硬限制
      # xfs_quota -x -c "limit -p bsoft=6M bhard=10M testdata" /data
      
      ##查看是否生效，以及使用情况
      # xfs_quota -x -c "report -bih" /data
      Project quota on /data (/dev/sdb1)
                              Blocks                            Inodes
      Project ID   Used   Soft   Hard Warn/Grace     Used   Soft   Hard Warn/Grace
      ---------- --------------------------------- ---------------------------------
      #0            20M      0      0  00 [------]      4      0      0  00 [------]
      testdata       0     6M    10M  00 [------]      1      0      0  00 [------]
      ```

      说明：

      ​	bsoft : 软限制，bsoft可以超过，但必须小于bhard，宽限期为7天（默认），超过7天容量都在bsoft和bhard直接，会拒绝继续写入

      ​	bhard : 硬限制，超过即不能写入

      6. 编辑nfs配置文件

         ```shel
         # vim /etc/exports
         /data/testdata 172.26.0.0/16(insecure,rw,sync,no_root_squash)
         # 保证所有用户都有权限
         chmod 777 /data/testdata
         ```

      7. client端挂载

         ```shel
         # client端必须存在testdata
         mkdir -p /data/testdata
         mount -t nfs 172.26.24.72:/data/testdata /data/testdata
         ```

      8. Client测试

         ```she
         # client端进入/data/testdata下
         dd if=/dev/zero of=/data/testdata/test bs=1M count=15
         ```

![image-20230608151709199](/Users/apple/Desktop/wiki图片存放/image-20230608151709199.png)					

9. 相关操作

```she
# server端查询使用情况,2种均可
xfs_quota -x -c "df -h" /data
xfs_quota -x -c "report -h" /data
# client端查询
df -h /data/testdata
# 调整容量限制
xfs_quota -x -c "limit -p bsoft=100M bhard=100M testdata" /data
```

​			