## 网络基础

#### 网络交换

线路交换：数据传输可靠、有序，但带宽固定，网络资源利用低，初始化连接慢

报文交换：存储接收到的报文，判断其目标地址以选择路由，在下一路由空闲时转发给下一路由

分组交换：将资料组合成适当大小的区块（封包），再通过网络传输

#### 网络拓扑结构

总线型、星型、树型、环形网络、全网状和部分网状

#### 衡量的主要指标

速率：单位bit

带宽

### OSI 与TCP/IP

#### OSI七层模型

应用层 表示层 会话层 传输层 网络层 数据链路层 物理层

#### TCP/IP四层模型

应用层 传输层（负责两台主机间通信，建立主机的端对端连接） 网络层 数据链路层

### 三次握手、四次挥手

#### 三次握手

![image-20230506235302023](C:\Users\stone\AppData\Roaming\Typora\typora-user-images\image-20230506235302023.png)

为了建立可靠的连接，客户端发送SYN包给服务器，并进入SYN_SENT状态，等待服务器确认；服务器确认，发送SYN包和ACK;客户端收到后发送ACK，发送完成成功连接

**为什么要三次握手**

同步seq序列号、确定MSS、窗口扩大、时间戳等，建立连接只能单工

#### 四次挥手

全双工通信

客户端发送FIN，用来关闭数据传送，进入FIN_WAIT_1状态

服务器收到FIN，返回ACK，进入CLOSE_WAIT状态

服务器发送FIN，关闭数据传送，进入LAST_ACK状态

客户端收到FIN，进入TIME_WAIT状态，发送ACK给服务器，Server进入closed

__为什么要四次挥手__

四次挥手是为了确保双方都能够正常地关闭连接，而关连接允许单工通信，CLOSE_WAIT可以存在很长时间，比如一年，就会占用大量资源，导致网络延迟，甚至带来安全风险

四次挥手关闭方法：close、shutdown

**CLOSE_WAIT过多排查思路**

1. 确保是否存在应用程序或服务端口泄露

2. 检查系统网络配置

3. 防火墙设置检查

4. 调整操作系统参数：如TCP缓冲区大小、TCP连接超时时间等

5. 负载均衡问题：负载均衡器设置地超时时间太短，mysql连接无法释放（代码层面）


**超时与重试**

操作系统文件: /proc/sys/net/ipv4/

主动方

FIN_WAIT 1

- net.ipv4.tcp_orphan_retries = 0  // 默认重试8次, ipv4下地tcp_orphan_retries

FIN_WAIT 2

- net.ipv4.tcp_fin_timeout = 60 // 60s

TIME_WAIT : 2MSL  // 2min

- net.ipv4.tcp_max_tw_buckets =

被动方

CLOSE_WAIT  // 没有时间限制

LAST_ACK

- net.ipv4.tcp_orphan_retries = 0

### 网络协议

#### 网络层

- IP：IP协议提供不可靠、无连接的传送服务，规定数据传输的主要内容，单向传输
- ARP：地址解析协议。将IP地址转化为物理MAC地址。在ARP缓存表中通过目标设备IP地址查询目标设备得MAC地址
- RARP：反向地址转换协议。允许局域网的物理机器从网关服务器的 ARP 表或者缓存上请求其 IP 地址。
- IGMP：组播协议包括组成员管理协议和组播路由协议。组成员管理协议用于管理组播组成员的加入和离开，组播路由协议负责在路由器之间交互信息来建立组播树。
- ICMP：Internet控制报文协议。用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。
- BGP :边界网关协议。处理像因特网大小的网络和不相关路由域间的多路连接。
- RIP：路由信息协议。是一种分布式的基于距离矢量的路由选择协议

#### 传输层

- TCP: 一种面向连接的、可靠的、基于字节流的传输层通信协议。（connect、listen、accept函数实现）// connect是client端
  - 一个连接只能一对一，一个端口可以有多个连接
  - TCP连接四元组：源地址、源端口、目的地址、目的端口

- UDP: 用户数据报协议，一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务。
  - 组播，一个组播组的成员，一人发送数据，每个成员都可以收到

- RTP： 实时传输协议，为数据提供了具有实时特征的端对端传送服务，如在组播或单播网络服务下的交互式视频音频或模拟数据。
- SCTP： 一个面向连接的流控制传输协议，它可以在两个端点之间提供稳定、有序的数据传递服务。SCTP可以看做是TCP协议的改进，它继承了TCP较为完善的拥塞控制并改进TCP的一些不足：
  - SCTP是多宿主连接，而TCP是单地址连接。
  - 一个TCP连接只能支持一个流，一个SCTP连接可以支持多个流
  - SCTP有更好的安全性。

### 应用层

<h4> 基于TCP的应用层协议

HTTP：超文本传输协议,默认80

- http是客户端先发，服务器收发（服务器固定IP，固定端口）
- 服务器同时服务很多客户，一个客户端可能会访问很多请求，所以需要客户端先请求
- 浏览器根据DOM树及渲染规则，会发出多个http请求

SMTP：简单邮件传输协议，默认25

FTP：文件传输协议，默认20，21 //20传输数据,21传输控制信息

Telnet：Internet远程登陆服务的标准协议和主要方式，默认23

SSH：安全外壳协议，为建立在应用层和传输层基础上的安全协议，默认22

**数据封包解包过程**

封装报文从上层到下层（应用层-->传输层-->网络层-->数据链路层-->物理层）

应用层：消息/报文(数据包)

传输层：数据包+TCP头

网络层：数据包+TCP头+IP头

数据链路层：数据包+TCP头+IP头+MAC头

物理层：比特流

解包从下往上

<h4> 基于UDP的应用层协议

TFTP：简单文件传输协议，默认69

SNMP：简单网络管理协议，由一组网络管理的标准组成，包含一个应用层协议、数据库模型和一组资源对象，默认161接收，Trap信息是162端口

DNS：域名解析服务，

### 网络分析工具

**Netflow Analyzer**

#### Wireshark

##### 如何通过抓包缩小问题边界
- 1.确定关键路径
- 2.多端抓包比对
  - 代理配置错误？

- 3.核对协议语法
- 4.确定问题协议层级
- 5.分析协议语义
- 6.比对软件
  - 中间件配置错误？
  - 使用错误？

#### HTTP/1、HTTP/2

GET / 按照DOM树

HTTP/1并发最多支持6个TCP连接

<h4> HTTP/2

通过虚拟Stream层实现应用层的多路复用功能，一个TCP连接，不会受到CRLF攻击（不是ASCR码分隔），通过Frame帧对消息进行二进制编码，效率更快

HEADER frame帧

DATA frame帧

HTTP/1升级HTTP/2途径：

- TCP协议上：gRPC
- TLS/SSL协议：ALPN

#### HTTP/3

QUIC + UDP，可以解决HTTP/2的队头阻塞（stream1、stream2....发送时丢包后续的就发不了）

#### linux关于网络分析的相关工具

ping：通常用来测试与目标机器的连通性

```
ping -c 10 -i 0.5 www.baidu.com # ping10次，每次间隔0.5秒
```

traceroute：用于追踪数据包在网络上的传输时的全部路径

```
traceroute -p 6888 www.baidu.com
```

mtr：合并ping和traceroute的功能

```
mtr -r www.baidu.com # 报告模式显示
```

ethtool # 获取以太网卡的配置信息或者修改配置

### 进程 、线程

进程：资源分配的基本单位，有独立的内存空间，一个进程可以有多个线程

线程：调度的基本单位，也可以说是进程中的一个执行任务，线程之间资源共享

协程：微线程，比线程更加轻量级，不被操作系统内核所管理，完全由程序控制。适用于IO阻塞且需要大量并发的场景

#### TLS/SSL协议

**1.非对称加密的工作方式**

公私密钥加解密(AES算法，用的最多的是AES-128)

**2.DH密钥协商协议的工作方式**

AES + DH 做身份验证

**3.PKI公钥体系与证书的鉴别**

签名：私钥先hash（hash可以把不管多大得data变为40字节）--> 加密私钥 --> 私钥 + CA证书 -- >Digitally signed data

验签：把Digitally signed data分为两部分 -- > 签名用公钥解密 ，data同时hash --> 对比结果

**4. 为什么HTTps比http更安全**

通信加密

验证通信方

### 交换机

按照逻辑拓扑结构进行的分类

**三层网络结构**：指核心层，汇聚层和接入层都部署

**二层网络结构**：指核心层，接入层都部署

**1）思科常用命令**

1. show interface：显示接口状态和统计信息
2. show running-config：显示当前运行配置
3. show ip interface brief：显示IP接口信息摘要
4. show vlan：显示VLAN信息
5. show mac address-table：显示MAC地址表
6. show arp：显示ARP缓存表
7. show cdp neighbors：显示CDP邻居信息
8. show spanning-tree：显示生成树协议信息
9. ping：测试网络连通性
10. traceroute：跟踪路由信息













