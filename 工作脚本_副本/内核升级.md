```
1. 卸载老内核
  sudo rpm -e kernel-headers --nodeps
  sudo rpm -e kernel-devel --nodeps
  sudo rpm -e kernel-tools-libs --nodeps
  sudo rpm -e kernel --nodeps
  sudo rpm -e kernel-tools --nodeps
2. 安装新内核
   yum localinstall ./*.rpm -y
3. 查看内核启动顺序、设置内核启动
   awk -F\' '$1=="menuentry " {print $2}' /etc/grub2.cfg
   grub2-set-default 0
4. 生成grub 配置文件
   grub2-mkconfig -o /boot/grub2/grub.cfg
5. reboot
6. uname -a
```

```
echo 30 > /proc/sys/vm/dirty_ratio
echo 10 > /proc/sys/vm/dirty_background_ratio
echo 3000 > /proc/sys/vm/dirty_expire_centisecs
```

```
kernel.sysrq=1
vm.swappiness = 0
vm.max_map_count=500000
net.core.somaxconn=8192

fs.file-max=655360
fs.nr_open=52706963
fs.inotify.max_user_instances=8192
fs.inotify.max_user_watches=1048576

net.ipv4.ip_forward=1
net.ipv4.neigh.default.gc_stale_time=120
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0
net.ipv4.conf.default.arp_announce = 2
net.ipv4.conf.lo.arp_announce=2
net.ipv4.conf.all.arp_announce=2
net.ipv4.tcp_max_tw_buckets = 5000
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 1024
net.ipv4.tcp_synack_retries = 2
net.ipv6.conf.lo.disable_ipv6 = 1
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1

net.ipv4.tcp_keepalive_time=600
net.ipv4.ip_forward=1
net.ipv4.neigh.default.gc_stale_time=120
net.ipv4.conf.all.rp_filter=0
net.ipv4.conf.default.rp_filter=0
net.ipv4.conf.default.arp_announce = 2
net.ipv4.conf.lo.arp_announce=2
net.ipv4.conf.all.arp_announce=2
net.ipv4.tcp_max_tw_buckets = 5000
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 1024
net.ipv4.tcp_synack_retries = 2
net.ipv6.conf.lo.disable_ipv6 = 1
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1

net.ipv4.tcp_keepalive_time=600
net.ipv4.tcp_keepalive_intvl=30
net.ipv4.tcp_keepalive_probes=10
net.ipv4.tcp_fin_timeout=3
net.ipv4.tcp_max_orphans=655360
net.ipv4.tcp_max_tw_buckets=300000
net.ipv4.ip_local_port_range=20000 60999
net.netfilter.nf_conntrack_max=2310720
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
fs.inotify.max_user_watches = 1048576

```

```
kubectl apply -f https://raw.githubusercontent.com/cloudnativelabs/kube-router/master/daemonset/kubeadm-kuberouter.yaml
kubectl apply -f https://raw.githubusercontent.com/kubernetes/website/master/content/en/examples/application/nginx-app.yaml
```

```
mv /etc/yum.repos.d/* *.bak
echo "[base]
name=CentOS7
baseurl="https://repo.huaweicloud.com/centos/\$releasever/os/\$basearch/"
enabled=1
gpgcheck=0" > local.repo
yum clean all
yum makecache
```

```
## 安装前提
不需要原本存在docker，否则会报错
包含k8s安装初始化
## 单机离线部署
解压文件到/etc/kubeasz/
# 1. 离线安装docker等
./ezdown -D
# 2. 启动容器
./ezdown -S
# 3.修改主机ip和hostname
vim /etc/kubeasz/clusters/k8s-01/hosts
# 4.安装
source ~/.bashrc
dk ezctl setup k8s-01 all (等同于docker exec -it kubeasz ezctl setup k8s-01 all)
# 5.分步安装
dk ezctl setup k8s-01 01（CA证书和k8s安装准备）
dk ezctl setup k8s-01 02（etcd安装）
dk ezctl setup k8s-01 03（安装container_runtime）
dk ezctl setup k8s-01 04（安装master）
dk ezctl setup k8s-01 05（安装node）
dk ezctl setup k8s-01 06（安装网络插件）
dk ezctl setup k8s-01 07（安装集群主要插件，coredns,nodelocaldns,metrics-server,dashboard)
dk ezctl setup k8s-01 08 (存储安装）
## 集群离线部署
解压文件到/etc/kubeasz/
# 1. 离线安装docker等
./ezdown -D
# 2. 启动容器
./ezdown -S
# 3.创建新集群 k8s-01
docker exec -it kubeasz ezctl new k8s-01
#然后根据提示配置'/etc/kubeasz/clusters/k8s-01/hosts' 和 '/etc/kubeasz/clusters/k8s-01/config.yml'：
#根据节点规划修改hosts 文件和其他集群层面的主要配置选项；其他集群组件等配置项可以在config.yml 文件中修改
# 4.安装
source ~/.bashrc
dk ezctl setup k8s-01 all

```

